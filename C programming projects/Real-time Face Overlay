#include <opencv2/opencv.h>
#include <opencv2/highgui/highgui_c.h>
#include <opencv2/objdetect/objdetect_c.h>

int main() {
    CvCapture* capture = cvCaptureFromCAM(0);
    // Load the pre-trained face model
    const char* cascade_name = "haarcascade_frontalface_default.xml";
    CvHaarClassifierCascade* cascade = (CvHaarClassifierCascade*)cvLoad(cascade_name, 0, 0, 0);

    if (!cascade) {
        printf("Error: Could not load classifier XML file\n");
        return -1;
    }

    CvMemStorage* storage = cvCreateMemStorage(0);
    cvNamedWindow("Face Filter", 1);

    while (1) {
        IplImage* frame = cvQueryFrame(capture);
        if (!frame) break;

        // Detection works best on small, grayscale images
        IplImage* gray = cvCreateImage(cvGetSize(frame), 8, 1);
        cvCvtColor(frame, gray, CV_BGR2GRAY);
        cvEqualizeHist(gray, gray); // Improve contrast

        // Detect faces
        CvSeq* faces = cvHaarDetectObjects(gray, cascade, storage, 1.1, 3, 0, cvSize(40, 40), cvSize(0,0));

        for (int i = 0; i < (faces ? faces->total : 0); i++) {
            CvRect* r = (CvRect*)cvGetSeqElem(faces, i);

            // Calculate where the "Hat" should go (above the face rectangle)
            CvPoint center;
            center.x = r->x + r->width * 0.5;
            center.y = r->y + r->height * 0.5;

            // Draw a rectangle for the face
            cvRectangle(frame, cvPoint(r->x, r->y), 
                        cvPoint(r->x + r->width, r->y + r->height), 
                        CV_RGB(255, 0, 0), 3, 8, 0);

            // DRAW THE "FILTER" (e.g., a green bar representing a hat)
            cvRectangle(frame, cvPoint(r->x, r->y - 20), 
                        cvPoint(r->x + r->width, r->y), 
                        CV_RGB(0, 255, 0), -1, 8, 0);
        }

        cvShowImage("Face Filter", frame);
        cvClearMemStorage(storage);
        cvReleaseImage(&gray);

        if (cvWaitKey(30) == 27) break;
    }

    cvReleaseHaarClassifierCascade(&cascade);
    cvReleaseMemStorage(&storage);
    cvReleaseCapture(&capture);
    return 0;
}
